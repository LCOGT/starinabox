/*
 * QueryLoader v2 - A simple script to create a preloader for images
 *
 * For instructions read the original post:
 * http://www.gayadesign.com/diy/queryloader2-preload-your-images-with-ease/
 *
 * Copyright (c) 2011 - Gaya Kessler
 *
 * Licensed under the MIT license:
 *   http://www.opensource.org/licenses/mit-license.php
 *
 * Version:  2.1
 * Last update: 11-1-2011
 * Modified by Stuart Lowe 8 March 2012
 *
 */

(function($) {

	var qLimages = new Array;
	var qLdone = 0;

	var qLimageContainer = "";
	var qLoverlay = "";
	var qLbar = "";
	var qLpercentage = "";
	var qLimageCounter = 0;

	var qLoptions = {
		onComplete: function () {},
			backgroundColor: "#222",
			background: "url('css/images/siab-logo.png') no-repeat center center",
			barColor: "#fff",
			barHeight: 1,
			percentage: false,
			deepSearch: true,
			completeAnimation: "fade",
			onLoadComplete: function () {
			if (qLoptions.completeAnimation == "grow") {
				$(qLbar).stop().css("width", "100%").animate({
					top: "0%",
					height: "100%"
				}, 500, function () {
					$(qLoverlay).fadeOut(500, function () {
						$(this).remove();
						qLoptions.onComplete();
					})
				});
			} else {
				$(qLoverlay).fadeOut(500, function () {
					$(qLoverlay).remove();
					qLoptions.onComplete();
				});
			}
		}
	}

	var createPreloadContainer = function() {
		qLimageContainer = $("<div></div>").appendTo("body").css({
			display: "none",
			width: 0,
			height: 0,
			overflow: "hidden"
		});
		for (var i = 0; qLimages.length > i; i++) {
			qLimageCounter++;

			var imgLoad = $("<img />").attr("src", qLimages[i]).bind("load", function() {
				completeImageLoading();
			});
			qLimageContainer.append(imgLoad)
		}
	}

	var addImageForPreload = function(url) {
		var image = $("<img />").attr("src", url).bind("load", function () {
			completeImageLoading();
		}).appendTo(qLimageContainer);
	}

	var completeImageLoading = function () {
		qLdone++;
		var percentage = (qLdone / qLimageCounter) * 100;
		$(qLbar).stop().animate({
			width: percentage + "%"
		}, 200);

		if (qLoptions.percentage == true) $(qLpercentage).text(Math.ceil(percentage) + "%");
		if (qLdone == qLimageCounter) destroyQueryLoader();
	}

	var destroyQueryLoader = function () {
		$(qLimageContainer).remove();
		if (document.getElementById("qLoverlay")) { $("#qLoverlay").hide()};
		qLoptions.onLoadComplete();
	}

	var createOverlayLoader = function () {
		qLoverlay = $("<div id='qLoverlay'></div>").appendTo("body");
		qLbar = $("<div id='qLbar'></div>").css({
			height: qLoptions.barHeight + "px",
			marginTop: "-" + (qLoptions.barHeight / 2) + "px",
			backgroundColor: qLoptions.barColor,
			width: "0%",
			position: "absolute",
			top: "50%",
			left:"0px"
		}).appendTo(qLoverlay);
		if (qLoptions.percentage == true) {
			qLpercentage = $("<div id='qLpercentage'></div>").text("0%").css({
				height: "40px",
				width: "100px",
				position: "absolute",
				fontSize: "3em",
				top: "50%",
				left: "50%",
				marginTop: "-" + (59 + qLoptions.barHeight) + "px",
				textAlign: "center",
				marginLeft: "-50px",
				color: qLoptions.barColor
			}).appendTo(qLoverlay);
		}
	}

	var findImageInElement = function (element) {
		var url = "";

		if ($(element).css("background-image") != "none") {
			var url = $(element).css("background-image");
		} else if (typeof($(element).attr("src")) != "undefined" && element.nodeName.toLowerCase() == "img") {
			var url = $(element).attr("src");
		}

		if (url.indexOf("gradient") == -1) {
			url = url.replace(/url\(\"/g, "");
			url = url.replace(/url\(/g, "");
			url = url.replace(/\"\)/g, "");
			url = url.replace(/\)/g, "");

			var urls = url.split(", ");

			for (var i = 0; i < urls.length; i++) {
				if (urls[i].length > 0) {
					var extra = "";
					if ($.browser.msie && $.browser.version < 9) {
						extra = "?" + Math.floor(Math.random() * 3000);
					}
					qLimages.push(urls[i] + extra);
				}
			}
		}
	}

	$.fn.queryLoader2 = function() {
		createOverlayLoader();

		this.each(function() {
			findImageInElement(this);
			if (qLoptions.deepSearch == true) {
				$(this).find("*:not(script)").each(function() {
					findImageInElement(this);
				});
			}
		});

		createPreloadContainer();

		return this;
	};

})(jQuery);